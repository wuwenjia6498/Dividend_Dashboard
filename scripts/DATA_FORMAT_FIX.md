# 成长指标数据格式修复说明

## 问题描述

前端详情页的"成长指标"数据异常，数值被放大了 100 倍：
- **错误显示**: 220% (实际应该是 2.2%)
- **原因**: Tushare API 返回的百分比数据是原始数字格式（例如 2.2 表示 2.2%），但前端认为存储的是小数比率格式（0.022 表示 2.2%）

## 修复内容

### 1. 修改 `fetch_financial_indicators` 函数

**位置**: `scripts/update_data.py:342-388`

**更改内容**:
- 添加了 `or_yoy` (营收增速) 和 `netprofit_yoy` (净利增速) 字段到 Tushare API 请求
- 对这些字段进行 **除以 100** 的转换，将百分比格式转换为小数格式

**转换逻辑**:
```python
# Tushare 返回的数据格式
or_yoy = 6.3569  # 表示 6.36%

# 转换为小数格式存储到数据库
revenue_growth_yoy = or_yoy / 100  # 0.063569

# 前端显示时
display = revenue_growth_yoy * 100 + "%"  # "6.36%"
```

### 2. 修改 `process_single_stock` 函数

**位置**: `scripts/update_data.py:579-605`

**更改内容**:
- 优先使用 `fina_indicator` 接口返回的增长数据（已正确转换）
- 只在 `fina_indicator` 没有数据时才使用手动计算的数据（来自 `fetch_growth_metrics`）
- 避免覆盖已经正确转换的数据

### 3. 受影响的字段

以下字段的数据格式已统一为**小数格式** (0.xx):

| 字段名 | Tushare 字段 | 原始格式示例 | 转换后格式 | 前端显示 |
|--------|--------------|--------------|------------|----------|
| ROE (净资产收益率) | `roe` | 9.1262 | 0.091262 | 9.13% |
| 毛利率 | `grossprofit_margin` | 45.32 | 0.4532 | 45.32% |
| 资产负债率 | `debt_to_assets` | 62.15 | 0.6215 | 62.15% |
| 营收增速 | `or_yoy` | 6.3569 | 0.063569 | 6.36% |
| 净利增速 | `netprofit_yoy` | -9.9811 | -0.099811 | -9.98% |

## 数据修复步骤

### 自动修复（推荐）

运行更新脚本重新获取并保存所有数据：

```bash
# 更新所有股票
python scripts/update_data.py

# 或更新单个股票
python scripts/update_data.py --symbol 600036
```

### 验证修复结果

1. 运行测试脚本查看数据格式：
```bash
python scripts/test_data_format.py
```

2. 检查前端详情页，确认百分比显示正常（例如 6.36% 而不是 636%）

## 技术说明

### Tushare 数据格式规范

Tushare Pro API 中，所有百分比相关字段返回的都是**原始数字**:
- `roe`: 9.1262 表示 9.1262%
- `or_yoy`: -16.5668 表示 -16.57%
- `grossprofit_margin`: 45.32 表示 45.32%

### 数据库存储规范

为了与前端显示逻辑统一，数据库中所有比率字段存储为**小数格式** (DECIMAL):
- ROE: 0.091262 (数据库) → 9.13% (前端)
- 营收增速: 0.063569 (数据库) → 6.36% (前端)

### 前端显示逻辑

前端假设数据库中的比率字段都是小数格式，显示时会乘以 100 并添加 `%` 符号：
```typescript
const displayPercentage = (value: number) => `${(value * 100).toFixed(2)}%`;
```

## 向后兼容性

- 旧数据（未除以 100）会在下次更新时自动修复
- `fetch_growth_metrics` 函数保留为备用，在 `fina_indicator` 无数据时使用
- 手动计算的增长率已经是小数格式，无需转换

## 测试数据示例

**贵州茅台 (600519) - 2025Q3**:
- 营收增速：6.3569% → 存储为 0.063569 → 显示为 6.36%
- 净利增速：6.2458% → 存储为 0.062458 → 显示为 6.25%

**中国神华 (601088) - 2025Q3**:
- 营收增速：-16.5668% → 存储为 -0.165668 → 显示为 -16.57%
- 净利增速：-9.9811% → 存储为 -0.099811 → 显示为 -9.98%

**招商银行 (600036) - 2025Q3**:
- 营收增速：-0.5101% → 存储为 -0.005101 → 显示为 -0.51%
- 净利增速：0.5195% → 存储为 0.005195 → 显示为 0.52%

## 相关文件

- `scripts/update_data.py` - 主要修改文件
- `scripts/test_data_format.py` - 数据格式验证脚本
- `frontend/app/stock/[symbol]/page.tsx` - 前端详情页（使用数据）

## 日期

修复日期：2025-11-26
